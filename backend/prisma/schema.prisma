generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---- ENUMLAR ----

enum Role {
  patient
  doctor
  admin
}

// --- GÜNCELLENDİ ---
// Yeni bir durum ekledik: PENDING_APPROVAL
enum ConsultationStatus {
  pending_photos      // Fotoğraf bekleniyor
  pending_review      // Doktor/Admin incelemesi bekleniyor
  review_completed    // İnceleme bitti (Artık randevu seçebilir)
  PENDING_APPROVAL    // Kullanıcı slot seçti, admin onayı bekleniyor (YENİ)
  treatment_scheduled // Admin onayladı, operasyon tarihi belli
  completed           // Operasyon tamamlandı
  cancelled           // İptal edildi
}

enum AngleTag {
  front
  top
  left_side
  right_side
  donor_area_back
  donor_area_side
  other
}

enum TimelineEventType {
  INFO    // Normal bilgi metni (örn: "Alkolü bırak")
  VIDEO   // Eğitim videosu (örn: "3. Gün Yıkama")
  UPLOAD  // Hastadan fotoğraf yüklemesini iste (örn: "10. Gün Kabuk Dökme")
}

// ---- TABLOLARIMIZ BAŞLIYOR ----

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  role          Role     @default(patient)
  createdAt     DateTime @default(now())
  
  fcmToken      String?  @unique // YENİ: Push notification için

  profile       PatientProfile?
  consultations Consultation[]
  sentMessages  ChatMessage[]    @relation("Sender")
  timelineEvents TimelineEvent[]
}

model PatientProfile {
  id                  String   @id @default(uuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName           String
  lastName            String
  dateOfBirth         DateTime
  phoneNumber         String
  country             String
  medicalHistoryNotes String?  @db.Text
}

// --- GÜNCELLENDİ ---
model Consultation {
  id          String   @id @default(uuid())
  patientId   String
  patient     User     @relation(fields: [patientId], references: [id])
  doctorId    String?
  status      ConsultationStatus @default(pending_photos)
  doctorNotes String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // YENİ: Admin onaylayınca, seçilen slottaki tarih buraya yazılacak.
  // Timeline (sigarayı bırak vs.) bu tarihi baz alacak.
  operationDate DateTime?

  photos          ConsultationPhoto[]
  messages        ChatMessage[]
  medicalFormData Json?

  // YENİ: Bu danışmanlık için seçilen randevu slotu
  selectedSlot   AppointmentSlot?
}

model ConsultationPhoto {
  id             String       @id @default(uuid())
  consultationId String
  consultation   Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  fileUrl        String       @db.Text
  angleTag       AngleTag
  uploadedAt     DateTime     @default(now())
}

model ChatMessage {
  id             String       @id @default(uuid())
  consultationId String
  consultation   Consultation @relation(fields: [consultationId], references: [id])
  senderId       String
  sender         User         @relation("Sender", fields: [senderId], references: [id])
  messageContent String       @db.Text
  timestamp      DateTime     @default(now())
  isRead         Boolean      @default(false)
}

model TimelineEvent {
  id          String   @id @default(uuid())
  patientId   String
  patient     User     @relation(fields: [patientId], references: [id])
  title       String
  description String?  @db.Text
  eventDate   DateTime // Bu tarih 'operationDate'e göre hesaplanacak
  isCompleted Boolean  @default(false)
  type        TimelineEventType @default(INFO)
  videoUrl    String?
}

// --- YENİ MODEL ---
// Adminin "boş randevu" olarak girdiği tarih/saat slotları
model AppointmentSlot {
  id       String   @id @default(uuid())
  dateTime DateTime @unique // Randevu tarihi ve saati (Benzersiz olmalı)
  isBooked Boolean  @default(false) // Seçildi mi?

  // Bu slot hangi danışmanlığa rezerve edildi?
  // (1'e 1 ilişki: Bir slot sadece bir danışmanlığa ait olabilir)
  consultation   Consultation? @relation(fields: [consultationId], references: [id])
  consultationId String?       @unique
}