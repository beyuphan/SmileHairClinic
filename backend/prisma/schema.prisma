// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  patient
  doctor
  admin
}

enum ConsultationStatus {
  pending_photos      // Başladı, foto yok
  pending_review      // Fotolar yüklendi
  reviewed            // İncelendi
  archived            // Arşiv
}

enum AngleTag {
  front
  top
  left_side
  right_side
  donor_area_back
  donor_area_side
  other
}

enum TimelineEventType {
  INFO    
  VIDEO   
  UPLOAD  
}

// ---- KULLANICI (HER ŞEYİN MERKEZİ) ----
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  role          Role     @default(patient)
  createdAt     DateTime @default(now())
  fcmToken      String?  @unique 

  profile       PatientProfile?
  
  // İLİŞKİLER (Artık her şey direkt User'a bağlı)
  consultations Consultation[] // Dosya paketleri
  appointments  AppointmentSlot[] // Randevuları
  
  // CHAT SİSTEMİ (Tek Kanal - WhatsApp Modeli)
  // Bu kullanıcının kendi kanalı (Hasta ise kendi mesajları + ona gelenler)
  chatChannel   ChatMessage[] @relation("ChannelOwner")
  
  // Bu kullanıcının "Yazar" olarak attığı mesajlar 
  sentMessages  ChatMessage[] @relation("MessageSender")

  timelineEvents TimelineEvent[]
}

model PatientProfile {
  id                  String   @id @default(uuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName           String
  lastName            String
  dateOfBirth         DateTime
  phoneNumber         String
  country             String
  medicalHistoryNotes String?  @db.Text
}

// SADECE "DOSYA PAKETİ"
model Consultation {
  id          String   @id @default(uuid())
  patientId   String
  patient     User     @relation(fields: [patientId], references: [id])
  
  status      ConsultationStatus @default(pending_photos)
  doctorNotes String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  photos          ConsultationPhoto[]
  medicalFormData Json?
}

model ConsultationPhoto {
  id             String       @id @default(uuid())
  consultationId String
  consultation   Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  fileUrl        String       @db.Text
  angleTag       AngleTag
  uploadedAt     DateTime     @default(now())
}

// YENİ CHAT MODELİ
model ChatMessage {
  id             String   @id @default(uuid())
  
  // Hangi kullanıcının sohbet odası?
  channelOwnerId String
  channelOwner   User     @relation("ChannelOwner", fields: [channelOwnerId], references: [id])
  
  // Mesajı kim yazdı? (Hasta veya Admin)
  senderId       String
  sender         User     @relation("MessageSender", fields: [senderId], references: [id])
  
  messageContent String   @db.Text
  timestamp      DateTime @default(now())
  isRead         Boolean  @default(false)
}

// YENİ RANDEVU MODELİ
model AppointmentSlot {
  id        String   @id @default(uuid())
  dateTime  DateTime @unique 
  isBooked  Boolean  @default(false) 

  // Randevuyu kim aldı? (Consultation zorunluluğu kalktı!)
  patientId String?
  patient   User?    @relation(fields: [patientId], references: [id])
  
  isConfirmed Boolean @default(false) // Admin onayı
}

model TimelineEvent {
  id          String   @id @default(uuid())
  patientId   String
  patient     User     @relation(fields: [patientId], references: [id])
  title       String
  description String?  @db.Text
  eventDate   DateTime 
  isCompleted Boolean  @default(false)
  type        TimelineEventType @default(INFO)
  videoUrl    String?
}